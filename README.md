# Калькулятор хеджирования Uniswap V3

**Файл:** `uniswap_v3_hedge_calculator.py`

---

## Описание

Этот скрипт реализует интерактивный графический интерфейс для расчёта и визуализации стратегий хеджирования позиций в пуле ликвидности Uniswap V3. Приложение позволяет:

- Рассчитать базовую позицию LP (либо в ETH, либо в USDC) по заданным границам диапазона и общей стоимости пула.
- Настроить и применить статический хедж (например, шорт фьючерс или опционы).
- Выполнить сеточное хеджирование (grid hedge) с выводом PnL и дельты по ценам.
- Построить динамический хедж с многоточечной последовательностью цен и ребалансировкой хедж-позиции.
- Экспортировать результаты расчётов и графики в CSV и PNG.

Приложение разработано на Python с использованием библиотек:

- `tkinter` — для GUI.
- `numpy`, `pandas`, `math` — для вычислений.
- `matplotlib`, `seaborn` — для визуализации.
- Внешний модуль `logic.py` — для расчётов ликвидности, дельты, комиссии.
- Внешний модуль `plotting.py` — для отрисовки графиков.

---

## Системные требования

- Python 3.7 или выше
- ОС Windows / macOS / Linux
- Установленные библиотеки:
  ```bash
  pip install numpy pandas matplotlib seaborn
  ```

---

## Установка и запуск

1. Склонируйте или скачайте репозиторий с файлом `uniswap_v3_hedge_calculator_refactored.py` и зависимыми модулями `logic.py`, `plotting.py`.
2. Убедитесь, что в той же папке присутствуют все необходимые файлы.
3. Установите зависимости:
   ```bash
   pip install numpy pandas matplotlib seaborn
   ```
4. Запустите скрипт:
   ```bash
   python uniswap_v3_hedge_calculator_refactored.py
   ```
5. Откроется окно приложения.

---

## Интерфейс приложения

В приложении реализованы четыре основные вкладки:

1. **Основная позиция**
2. **Хеджирование**
3. **Сеточное хеджирование** (скрытая, используется внутри кода)
4. **Динамический хедж**

Каждая вкладка содержит набор полей ввода, кнопок для запуска расчётов и область для графиков или таблиц.

### 1. Основная позиция

- **Входные параметры**:
  - Текущая цена (ETH в USDC).
  - Нижняя и верхняя границы диапазона (USDC).
  - Общая стоимость пула (USDC).

- **Результаты**:
  - Ликвидность (L).
  - Количество ETH и USDC в пуле на текущей цене.
  - Количество активов при достижении нижней и верхней границы.

- **Кнопка**:
  - **Обновить графики** — перерисовывает диапазон ликвидности и стоимость позиции.

- **График**:
  - Верхний: объёмы ETH и USDC по цене.
  - Нижний: общая стоимость позиции (USDC).

### 2. Хеджирование

- **Настройки хеджирования**:
  - Включить/выключить хедж.
  - Выбор инструмента: фьючерс, опцион PUT/CALL.
  - Количество хеджируемых ETH.
  - Цена входа хеджа.
  - Комиссия (%).
  - Кнопки "Авто-хедж" (подбор по LP), "Применить хедж".

- **Результаты**:
  - Позиция хеджа (ETH и USDC).
  - Комиссия за вход.

- **Анализ при выходе**:
  - Поле цена выхода.
  - Кнопка "Рассчитать результат".
  - P&L базовой позиции, P&L хеджа, комиссия, общий P&L.
  - Цветовое выделение (зелёный для прибыли, красный для убытка).

- **График**:
  - Сравнение стоимости позиции без хеджа и с хеджем.
  - P&L хеджа.
  - Маркер цены выхода и аннотации.

### 3. Сеточное хеджирование

_Вкладка создаётся, но напрямую не отображается в интерфейсе. Используется для экспортов._

В коде реализованы:
- Настройка шага сетки (USDC) и комиссии (%).
- Вывод таблицы цен и дельт.
- Графики: дельта по цене, P&L по цене.
- Симуляция по списку цен (загрузка из файла, ввод через запятую).

### 4. Динамический хедж

Позволяет задать **последовательность цен** и автоматически ребалансировать хедж при каждом изменении цены.

- **Параметры**:
  - Шаг изменения цены для генерации промежуточных точек.
  - Комиссия (%).

- **Ввод цен**:
  - **Построчно** — добавьте поля по одной цене.
  - **Массово** — переключитесь в режим "Все сразу" и вставьте список цен через запятую или каждую с новой строки.
  - Кнопки: Добавить цену, Удалить, Загрузить из файла, Просмотр таблицы, Очистить.

- **Расчёт динамического хеджа**:
  - Кнопка "Рассчитать динамический хедж".
  - Пояснение: расчёт P&L основной позиции и хеджа на каждом шаге, учёт комиссий и ребалансировок.

- **Результаты**:
  - Таблица с монопространственным выравниванием:
    - Шаг, Цена, ETH-пул, USDC-пул, Стоимость пула, Объём хеджа, Дельта, Комиссия, P&L хеджа, P&L базы, Итоговый P&L, Стратегия.
  - Блок "Итоговые результаты": итоговая дельта, P&L позиции, P&L хеджа, общий и чистый P&L, комиссии.

- **График**:
  - Профиль P&L: линии P&L базовой позиции, P&L хеджа и общего P&L.
  - Отметки стратегий (сокращение/увеличение шорта).
  - Аннотации с ценами и пояснения.

---

## Экспорт результатов

В каждой вкладке есть функции экспорта:

- **CSV** — сохраняет табличные результаты.
- **PNG** — сохраняет текущий график (Основной и хедж-график).

Пути экспорта задаются через стандартные диалоги сохранения файла.

---

## Работа с файлами цен

- **.txt/.csv** — можно загрузить список цен:
  - При наличии запятых скрипт определяет формат и разбивает список.
  - Если загружено >10 цен в динамическом хедже, предлагается режим массового ввода.

---

## Советы и рекомендации

1. Перед расчётом убедитесь в корректности локальных разделителей (`,`, `.`).
2. Используйте "Авто-хедж" для быстрого подбора объёма ETH для хеджа.
3. При больших объёмах данных переключайтесь в массовый режим ввода цен.
4. Для оптимальной работы графики перерисовываются при изменении размера окна.
5. В случае ошибок см. вывод в консоли (traceback).

---

## Лицензия

Скрипт распространяется без каких-либо гарантий и может быть адаптирован под ваши задачи.

---

*Документ сгенерирован автоматически.*
